<!-- Htmldoc has been run -->
<!--
   @author    Andy Frank
   @creation  28 Mar 05
   @version   $Revision$ $Date$
   @since     Niagara 3.0
 -->
 
<html>

<head>
<title>Hx - HxView</title>
<link rel='stylesheet' href='module://docDeveloper/rc/sunlight.default.css'>
<!-- Auto-generated style sheet link --><link rel='StyleSheet' href='module://bajaui/doc/style.css' type='text/css' />
<!-- Auto-generated js link for Activity Monitoring --><script type='text/javascript' src='module://web/rc/util/activityMonitor.js'></script>
<script type='text/javascript'>window.addEventListener('load', activityMonitor.start);</script>
</head>

<body>
<!-- Auto-generated Header NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/hx.html" class="navbar">Prev</a> |  <a href="/doc/hx-hxOp.html" class="navbar">Next</a></p>


<script type='text/javascript' src='module://docDeveloper/rc/sunlight-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.java-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.xml-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/niagara-sunlight-support.js'></script>

<!-- Title Block -->
<h1 class='title'>Hx - HxView</h1> 

<!------------------------------------------------------------->
<h1 id="overview">HxView Overview</h1>
<!------------------------------------------------------------->
                                      
<p>
<a href='module://docDeveloper/doc/hx-wb/javax/baja/hx/BHxView.bajadoc'><code>HxView</code></a>
provides the content viewers and editors for working with the active objects.
As you have probably guessed, <code>HxView</code> is the Hx equivalent of
<code>WbView</code>.  <code>HxView</code> is designed to produce and interact
with a snippet of HTML.  <a href='hx-hxProfile.html'>BHxProfile</a> takes one
or more <code>HxViews</code>, adds some supporting markup plus some chrome, and
produces a complete HTML page.
</p>

<br><br>

<table align="center">
  <tr><td align="center">
    <img src="hx-communication.png" border="0">
  </td></tr>
</table>

<p>
From the diagram, a <code>HxView</code>:
</p>

<ul>
<li>
  Must have logic to render a HTML snippet from an object (write). This is
  synonymous to <code>BWbView.doLoadValue()</code>.
</li>
<li>
  May have logic to save changes back to the object (save).  This is
  synonymous to <code>BWbView.doSaveValue()</code>.
</li>
<li>May have logic to periodically update the HTML snippet (update).</li>
<li>May have logic to respond to client background requests (process).</li>
</ul>

The name in parenthesis at the end of each bullet is the corresponding method
in <code>HxView</code> responsible for that behavior.  Details on each method 
can be found below. The <a href='hx-hxProfile.html'>HxProfile</a> is 
responsible for building the containing HTML around each HxView.

<!------------------------------------------------------------->
<h1 id="example">Example</h1>
<!------------------------------------------------------------->

<p>
The details of each method can be found at the end of this document, but lets
take a simple example to walk through the API:
</p>

<pre>
  <code class="sunlight-highlight-java">
  public class BFooView extends BHxView
  {
    public static final BFooView INSTANCE = new BFooView();
    
    public Type getType() { return TYPE; }
    public static final Type TYPE = Sys.loadType(BFooView.class);

    protected BFooView() {}

    public void write(HxOp op) throws Exception
    {
      BFoo foo = (BFoo)op.get();
      HtmlWriter out = op.getHtmlWriter();
      out.w("Current name: ").w(foo.getName()).w("&lt;br/&gt;");
      out.w("&lt;input type='text' name='").w(op.scope("name")).w("'");
      out.w(" value='").w(foo.getName()).w("' /&gt;&lt;br/&gt;");
      out.w("&lt;input type='submit' value='Submit' /&gt;");
    }

    public BObject save(HxOp op) throws Exception
    {
      BFoo foo = (BFoo)op.get();
      foo.setName(op.getFormValue("name"));
      return foo;
    }  
  }
  </code>
</pre>
  
<pre>
  <code class="sunlight-highlight-xml">
  // Register this view on BFoo in module-include.xml
  &lt;type name="FooView" class="bar.BFooView"&gt;
    &lt;agent&gt;&lt;on type="bar:Foo"/&gt;&lt;/agent&gt;
  &lt;/type&gt;  
  </code>
</pre> 

<p>
Assuming the current name in our <code>BFoo</code> object is "Peter Gibbons",
the above code will produce the following HTML (ignoring the profile):
</p>

<pre>
  <code class="sunlight-highlight-xml">
  Current name: Peter Gibbons&lt;br/&gt;
  &lt;input type='text' name='name' value='Peter Gibbons' /&gt;&lt;br/&gt;
  &lt;input type='submit' value='Submit' /&gt;
  </code>
</pre>

<p>
If you are familiar with Niagara AX and HTML, this should be pretty 
straightforward. Let's walk through it though.  Here's the class hierarchy of
the main hx components:
</p>

<br><br>

<table align="center">
  <tr><td align="center">
    <img src="hx-classDiagram.png" border="0">
  </td></tr>
</table>

<p>
The first thing to note is that 
<code>BHxView</code> extends  
<a href='module://docDeveloper/doc/web-rt/javax/baja/web/BServletView.bajadoc'>
<code>BServletView</code></a>, which extends 
<a href='module://docDeveloper/doc/baja-rt/javax/baja/sys/BSingleton.bajadoc'>
<code>BSingleton</code></a>, which requires a <code>public static final
INSTANCE</code> variable for all concrete implementations. If you have ever
programmed Servlets before, you'll know that a Servlet must be re-entrant, and
<code>HxViews</code> follow the same model.  The <code>INSTANCE</code> 
object is what will be used to handle requests. (The <code>protected</code>
constructor is a convention used to enforce the singleton design pattern). 
Since <code>HxView</code> can't maintain state while its doing its thing, we 
need to stash stuff somewhere - thats where <a href='hx-hxOp.html'>HxOp</a> 
comes in. We won't get into the details of <code>HxOp</code> yet, just be aware
that anything I need to know about my current request or response is very 
likely accessible via the op.
</p>

<h3>Producing the HTML</h3>
<p>
Let's move on to the lifecycle of an <code>HxView</code>.  The first thing a
view will do is render its HTML to the client.  This occurs in the 
<code>write()</code> method.  By default Hx documents use the XHTML 1.0 Strict
DOCTYPE. So you are encouraged to use valid XHTML in your <code>write</code>
method. Since <code>HxViews</code> are designed to be chromable, and 
compositable, you'll also only write the markup that directly pertains to this
view in your <code>write</code> method.  Here are the things you should take
note of about <code>write</code>:
</p>

<ul>
<li>
  Think <code>BWbView.doLoadValue()</code>
</li>
<li>
  Only write the HTML that directly pertains to this view.
</li>
<li>
  You should always use <code>op.scope()</code> when writing a form
  element name. We'll get to why you should do that in 'Writing Reusable
  HxViews' down below.
</li>
<li>
  This is just a plain old HTML form, so all the normal form elements are
  applicable. And of course any other HTML.
</li>
<li>
  To allow for asynchronous saving, users are encouraged to no longer submit forms, but instead
  override the input's onclick method to call 'hx.save()' which will submit the form when all the HxViews
  are ready. <code>&lt;input type='button' onclick='hx.save' /&gt;</code>
  The Hx framework will take care of building the <code>form</code> tag so this request gets routed to
  your <code>save()</code> method.
</li>
<li>
  In case you need to add javascript in your write method use <code>HxOp.addOnload(String)</code> instead of using a
  <code>&lt;script/&gt;</code>. This allows the HxView to be reusable in a <code>javax.baja.hx.Dialog</code> or in another
  case that requires putting the results of the <code>write</code> method in a POST.
</li>
</ul>

<h3>Saving Changes</h3>
<p>
Ok, my name is not "Peter Gibbons", so we need to be able to save something
else back to the station. This is just as easy as writing my HTML, you simply
implement a <code>save</code> method on your view. The request will 
automatically be routed, and all form data will be available from the 
<code>HxOp.getFormValue()</code> method.
</p>

<p>
So now if I view our example view in my browser, enter "Michael Bolton" and hit
"Submit", the page will refresh to display:

<pre>
  <code class="sunlight-highlight-xml">
  Current name: Michael Bolton&lt;br/&gt;
  &lt;input type='text' name='name' value='Michael Bolton' /&gt;&lt;br/&gt;
  &lt;input type='submit' value='Submit' /&gt;
  </code>
</pre>

<p>
Technically, what happens, is the POST request gets routed to
<code>save</code>, then Hx responds with a redirect back the same location. 
This forces the page contents to be requested on a GET request, avoiding
double-posting problems.
</p>

<!------------------------------------------------------------->
<h1 id="reusableViews">Writing Reusable HxViews</h1>
<!------------------------------------------------------------->
<p>
Hx is designed to allow for reusing and nesting <code>HxViews</code> within 
other <code>HxViews</code>. To accomplish this, we need some type of scoping
mechanism to avoid naming conflicts.  Luckily, Hx handles this quite cleanly.
Each HxOp that gets created has a name (explicit or auto-generated),
which when combined with its parent tree, creates a unique path to each 
"instance" of a <code>HxView</code>.  So if you take the this code:
</p>

<pre>
  <code class="sunlight-highlight-java">
  public void write(HxOp op) throws Exception
  {
    HtmlWriter out = op.getHtmlWriter();
    out.w("&lt;input type='text' name='").w(op.scope("foo")).w("'/&gt;");
    ...
  }
  
  public BObject save(HxOp op) throws Exception
  {
    String foo = op.getFormValue("foo");
    ...
  }
  </code>
</pre>

<p>
The resulting HTML could look something like this:
</p>

<pre>
  <code class="sunlight-highlight-java">
  &lt;input type='text' name='uid1.editor.uid5.foo'/&gt;
  </code>
</pre>

<p>
<code>HxOp.getFormValue()</code> will automatically handle the "unscoping" 
for you. This allows any <code>HxView</code> to be nested anywhere without
knowing its context. However, this only works if you follow a few rules:
</p>

<ul>
  <li>
    Always give sub-views a sub-op using <code>HxOp.make()</code> - there
    should always be a 1:1 ratio between <code>HxOps</code> and 
    <code>HxViews</code>.  See "Managing Subviews" below.    
  </li>
  <li>
    Always use <code>HxOp.scope()</code> when writing the <code>name</code>
    attribute for a form control.
  </li>
  <li>
    When using the auto name constructor of <code>HxOp</code>, names are 
    created by appending the current counter value to a string ("uid0", 
    "uid1", etc). So its very important that the order in which
    <code>HxOps</code> are created is always the same in 
    write/save/update/process so the produced paths will always the same.
    Otherwise views will not be able to correctly resolve their control values.
  </li>
</ul>  

<h2>Managing Subviews</h2>

<p>
Hx does not contain any notion of containment, so composite views are 
responsible for routing all write/save/update/process requests to its children:
</p>

<pre>
  <code class="sunlight-highlight-java">
  public class BCompositeView extends BHxView
  {
    public void write(HxOp op) throws Exception
    {
      BSubView.INSTANCE.write(makeSubOp(op));
      ...
    }
    
    public BObject save(HxOp op) throws Exception
    {
      BFoo foo = BSubView.INSTANCE.write(makeSubOp(op));
      ...
    }
    
    public void update(HxOp op) throws Exception
    {
      BSubView.INSTANCE.update(makeSubOp(op));
    }
  
    public boolean process(HxOp op) throws Exception
    {
      if (BSubView.INSTANCE.process(makeSubOp(op))) 
        return true;
      return false;
    }
    
    private HxOp makeSubOp(HxOp op)
    {
      BFoo foo;
      ...
      return op.make(new OrdTarget(op, foo));
    }
 }
  </code>
</pre>

<p class="note">
Don't forget to always create a sub-op to your child views so the Hx framework
can strut its stuff.
</p>

<!------------------------------------------------------------->
<h1 id="wbAgents">Writing HxView Agents for WbViews</h1>
<!------------------------------------------------------------->

<p>
Another feature of the hx framework is a transparent transition from the 
Workbench environment  to the hx environment. For example, if you have created
a <code>WbView</code> called <code>WbFooView</code>, all references to that
view can be made to transparently map to your hx implementation. You just need
to register your <code>HxView</code> directly on the <code>WbView</code>, and
expect the input argument to be the same type as loaded into the 
<code>WbView</code>:
</p>

<pre>
  <code class="sunlight-highlight-xml">
  // Register WbView agents directly on the View
  &lt;type name="HxFooView" class="foo.BHxFooView"&gt;
    &lt;agent&gt;&lt;on type="foo:WbFooView"/&gt;&lt;/agent&gt;
  &lt;/type&gt;
  </code>
</pre>
  
<pre>
  <code class="sunlight-highlight-java">
  public void write(HxOp op)
    throws Exception
  {
    // Assume object is what the corresponding WbView would 
    // receive in its doLoadValue() method.
    BFoo foo = (BFoo)op.get();
    ...
  }
  </code>
</pre>

<p>  
Then this ord will work correctly in both environments:
</p>

<pre>
  station:|slot:/bar|view:foo:WbFooView
</pre>

<p>  
Also note that if your view is the default view on that object, the default
ord will choose the correct view as well:
</p>

<pre>
  station:|slot:/bar
</pre>

<!------------------------------------------------------------->
<h1 id="pxAgents">Writing HxView Agents for Px Widgets</h1>
<!------------------------------------------------------------->

<p>
Similar to creating <code>WbView</code> agents, a <code>BHxPxWidget</code>
is responsible for creating an hx representation of a <code>BWidget</code> used
in a Px document.  Note that <code>BHxPxWidget</code> works differently from a
typical <code>HxView</code> in that op.get() will return the
<code>BWidget</code> that this agent is supposed to model. The widget will
already be mounted in a <code>BComponentSpace</code> and any bindings will
already be active and leased. Also note that in <code>module-include.xml</code>
this type should be registered as agent on the BWidget it is supposed to model.
</p>

<pre>
  <code class="sunlight-highlight-xml">
  // Register PxWidget agents directly on the Widget
  &lt;type name="HxPxLabel" class="com.tridium.hx.px.BHxPxLabel"&gt;
    &lt;agent&gt;&lt;on type="bajaui:Label"/&gt;&lt;/agent&gt;
  &lt;/type&gt;
  </code>
</pre>
  
<pre>
  <code class="sunlight-highlight-java">
  public void write(HxOp op)
    throws Exception
  {
    // OrdTarget is the widget we want to model
    BLabel label = (BLabel)op.get();
    
    HtmlWriter out = op.getHtmlWriter();
    out.w(label.getText());
  }
  </code>
</pre>


<!------------------------------------------------------------->
<h1 id="multiPart">Uploading Files with Multi-part Forms</h1>
<!------------------------------------------------------------->

<p>
Hx supports file uploading by using the multi-part encoding for form
submission. This capability is only supported for standard form submissions.
You may upload one or more files along side the rest of your form.  The files
are stored in a temporary location on the station, and if not moved, will be
automatically deleted at the end of the request.
</p>

<ul>
<li>
  Must call <code>op.setMultiPartForm()</code> to change form encoding.
</li>  
<li>
  Uploaded files are accessible from <code>op.getFile()</code>, where the
  control name designates which file you want.
</li>
<li>
  If the file is not explicitly moved to another location, it will be deleted
  at the end of the request.
</li>
</ul>

<p>
Let's take an example:
</p>

<pre>
  <code class="sunlight-highlight-java">
  public void write(HxOp op) throws Exception
  {
    op.setMultiPartForm();
    out.w("&lt;input type='file' name='someFile' /&gt;");
  }
  
  public BObject save(HxOp op) throws Exception
  {
    BIFile file = op.getFile("someFile");    
    FilePath toDir = new FilePath("^test");
    BFileSystem.INSTANCE.move(file.getFilePath(), toDir, op);
    return op.get();
  }
  </code>
</pre>

<p>
This code will upload a file to a temporary file, accessible as "someFile", 
and move it to another location so that it will not be deleted at the end of
the request.
</p>

<!------------------------------------------------------------->
<h1 id="methodDetails">HxView Methods in Detail</h1>
<!------------------------------------------------------------->

<h2 id="write">write</h2>
<p>
Write is used to output the HTML markup for the current view. 
<code>HxViews</code> should only write the markup that directly pertains to 
itself. Avoid writing any containing markup - this is handled by the parent 
view or the profile. Especially avoid writing outer tags like 
<code>html</code>, <code>head</code>, and <code>body</code> - these are 
handled by the profile.
</p>
<p>
There is only one <code>form</code> tag in an hx page, and is written by the 
profile. <code>HxViews</code> should never write their own <code>form</code>
blocks.  So by design, the entire page content is encoded for <code>save</code>
and <code>Events</code>. Naming collisions are handled automatically using the
<code>HxOp</code> scoping rules (see 'Writing Reusable HxViews' above for more
info on scoping).
</p>
<p>
The <code>write</code> method is always called on an HTTP GET request. However,
if its written correctly (which typically means escaping quotes properly), it 
may be reused by <code>update</code> or <code>process</code> if it makes sense.
</p>

<h2 id="save">save</h2>
<p>
Save is used to save changes made from the view back to the target object. This
is usually just a standard response to a form post, where the form values are
accessed using <code>HxOp.getFormValue()</code>.  Views on <code>BSimples</code>
should return a new instance based on their new value.  Views on 
<code>BComponents</code> should modify the existing instance and return that 
instance.
</p>
<p>
After a save is handled, a redirect is sent back to the 
browser to the current location.  This is used to refresh the current page 
values, but more importantly to avoid double-posting problems.  Content is 
always be requested on a GET request (and handled by <code>write</code>).  You 
may choose to redirect back to a different URL using the 
<code>HxOp.setRedirect()</code> method.
</p>
<p>
The <code>save</code> method is always called on a standard HTTP POST form
submit request.  Both standard url-encoded and multi-part forms are supported.
See 'Uploading Files with Multi-part Forms' above for info on multi-part forms.
</p>

<h2 id="update">update</h2>
<p>
Update is automatically called periodically on all views if at least one
view was marked as dynamic (via <code>HxOp</code>).  This is a background 
request made using JavaScript and XmlHttp.  The content returned to the 
browser must be executable JavaScript. For example:
</p>

<pre>
  <code class="sunlight-highlight-java">
  public void write(HxOp op) throws Exception
  {
    op.setDynamic();
    HtmlWriter out = op.getHtmlWriter();
    out.w("&lt;div id='time'&gt;Current Time&lt;/div&gt;");
  }
  
  public void update(HxOp op) throws Exception
  {
    HtmlWriter out = op.getHtmlWriter();
    out.w("var elem = document.getElementById('time');");
    out.w("elem.innerHTML = '").w(BAbsTime.now()).w("';");
  }
  </code>
</pre>

<p>
Here, after the page is initially written, the browser will poll the station
every five seconds running <code>update</code> on all the views.  So this code
will simply update the current time each time the station is polled.
</p>

<h2 id="process">process</h2>
<p>
Process is used to handle non-update background requests.  A process request
is targeted and serviced by a single <code>HxView</code>.  The default 
implementation for process handles routing events to the correct view.  See
<a href='hx-events.html'>Events</a>.
</p>
<p class="note">
Note: If you override process, you must call super or event routing will fail.
</p>

<script type="text/javascript">
    window.niagara.docDevUtil.highlightCode();
</script>

<!-- Auto-generated Footer NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/hx.html" class="navbar">Prev</a> |  <a href="/doc/hx-hxOp.html" class="navbar">Next</a></p>
<!-- Auto-generated copyright note --><p class='copyright'></p>
</body>
</html>
