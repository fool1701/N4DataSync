<!-- Htmldoc has been run -->
<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<link rel='stylesheet' href='module://docDeveloper/rc/sunlight.default.css'>
<!-- Auto-generated style sheet link --><link rel='StyleSheet' href='module://bajaui/doc/style.css' type='text/css' />
<!-- Auto-generated js link for Activity Monitoring --><script type='text/javascript' src='module://web/rc/util/activityMonitor.js'></script>
<script type='text/javascript'>window.addEventListener('load', activityMonitor.start);</script>
</head>
<body>
<!-- Auto-generated Header NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/xml.html" class="navbar">Prev</a> |  <a href="/doc/distribution.html" class="navbar">Next</a></p>

<script type='text/javascript' src='module://docDeveloper/rc/sunlight-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.java-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.javascript-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.xml-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.css-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/niagara-sunlight-support.js'></script>

<h1 id="bog-files">Bog Files</h1>
<h2 id="overview">Overview</h2>
<p>Niagara provides a standard XML format to store a tree of <a href="module://docDeveloper/doc/baja-rt/javax/baja/sys/BValue.bajadoc"><code>BValues</code></a>. This XML format is called &ldquo;BOG&rdquo; for Baja Object Graph.  The bog format is designed for the following criteria:</p>
<ul>
  <li>Easy to serialize a graph to an output stream using one pass</li>
  <li>Easy to deserialize a graph from an input stream using one pass</li>
  <li>Compact XML, using single letter element and attribute names</li>
  <li>Ability to compress using zip</li>
</ul>
<p>Bog files are typically given a &ldquo;.bog&rdquo; extension. Bog files designed for use as palletes use the &ldquo;.palette&rdquo; extension, and though they use the same format as &ldquo;.bog&rdquo; files, they may not use reversible encodings for <a href="module://docDeveloper/doc/baja-rt/javax/baja/security/BPassword.bajadoc"><code>BPassword</code></a> values (see discussion of encoding and key source below).</p>
<p>Bog files can be flat XML files or stored inside zip files. If zipped, then the zip file contains a single entry called &ldquo;file.xml&rdquo; with the XML document. You can use Workbench to copy any <code>BValue</code> to a directory on your file system to easily generate a bog file.</p>
<h2 id="compatibility">Compatibility</h2>
<p>Bog files created by Niagara AX systems use an encoding for passwords that is <em>incompatible</em> with Niagara 4 API and tools. For best results, any AX files should first be converted using the <a href="module://docAXtoN4/doc/rAboutAxToN4MigrationGuide.html">Niagara 4 migration tool</a>.</p>
<h2 id="password-encoding-and-encryption-keys">Password Encoding and Encryption Keys</h2>
<p>In Niagara 4 bog files, all <code>BPassword</code> values are encoded using some form of strong encryption. The encoding that&rsquo;s used for a particular value depends on whether it must be possible to retrieve the original value from the file (a <em>reversible</em> encoding is used), or whether it&rsquo;s enough just to be able to verify that a given value matches the original (a <em>non-reversible</em> encoding is used). Niagara typically uses reversible encodings for password values only when the system needs to send the value to another system for authentication (an email server, another Niagara station, <em>etc.</em>). Most password values, like those in a station&rsquo;s user service, use a non-reversible encoding.</p>
<p>Non-reversible encoding is done in the same way everywhere it&rsquo;s used, so it&rsquo;s not necessary for bog files to have any special information telling systems how to decode. However, for password values that use reversible encoding, the secret encryption key that&rsquo;s used is <em>never stored in the file itself</em>, and the file has to contain information telling the decoder how to get the key. A <strong>key source</strong> attribute describes this, and the choice has important implications for the security and portability of the file. Possible values:</p>
<table>
  <thead>
    <tr><th align="left">Key Source</th><th align="left">Description</th><th align="left">File Security and Portability</th></tr>
  </thead>
  <tbody>
    <tr><td align="left"><strong>none</strong></td><td align="left">The file does not and cannot have any reversibly-encoded password values.</td><td align="left">Best portability; consumers don&rsquo;t have to know a passphrase or have access to a particular system&rsquo;s &ldquo;key ring&rdquo;.</td></tr>
    <tr><td align="left"><strong>keyring</strong></td><td align="left">Reversibly-encoded password values are encrypted using a randomly-generated secret key stored in a &ldquo;key ring&rdquo; on the system where the file resides.</td><td align="left">Best security, but values are not readable on other systems.</td></tr>
    <tr><td align="left"><strong>external</strong></td><td align="left">Reversibly-encoded password values are encrypted using a secret key derived from a human-provided passphrase, which may be a controller&rsquo;s &ldquo;system passphrase&rdquo;, may be assigned by Workbench user working with files offline, <em>etc.</em> </td><td align="left">Portable. Correct passphrase needs to be supplied when reading encoded password values.</td></tr>
  </tbody>
</table>
<p>Developers should note that the &lsquo;keyring&rsquo; key source&rsquo;s limited portability can cause unexpected problems for users when they copy files directly without using Niagara tools. Niagara software:</p>
<ul>
  <li><em>always</em> uses keyring encoding in the platform/station&rsquo;s user home directory (under <code>C:\Program Data</code> on Windows systems)</li>
  <li><em>never</em> uses keyring encoding outside of the platform/station&rsquo;s user home directory</li>
  <li>converts between keyring and external encoding when transferring bog files over a platform connection</li>
</ul>
<p>Software developers should choose key source with this in mind.</p>
<h2 id="api">API</h2>
<p>In general the best way to read and write bog files is via the standard APIs. The <a href="module://docDeveloper/doc/baja-rt/javax/baja/io/ValueDocEncoder.bajadoc"><code>ValueDocEncoder</code></a> class is used to write <code>BValues</code> to an output stream using bog format.  You can use the <code>ValueDocEncoder.setZipped()</code> method to compress the bog file to to a zip file with one entry called &ldquo;file.xml&rdquo;. In general you should use the <code>encodeDocument()</code> method to generate a complete bog document. However you can also use <code>ValueDocEncoder</code> to stream multiple BValues to an XML document using <code>encode()</code>.</p>
<p>The <a href="module://docDeveloper/doc/baja-rt/javax/baja/io/ValueDocDecoder.bajadoc"><code>ValueDocDecoder</code></a> class is used to decode a bog document back into <code>BValue</code> instances. When decoding a bog file, the decoder will automatically detect if the file is zipped or not. General usage is to use <code>decodeDocument()</code> in conjunction with <code>ValueDocEncoder.encodeDocument()</code> for decoding the entire XML document as a <code>BValue</code>.  However <code>ValueDocDecoder</code> can also be used to decode BValues mixed with other XML data using <code>ValueDocDecoder.decode()</code> and the standard <code>XParser</code> APIs.</p>
<p><code>ValueDocEncoder.marshal()</code> and <code>ValueDocDecoder.unmarshal()</code> are convenience methods to encode and decode a BValue to and from a String.</p>
<p>When running in a station, creating a bog file that will be read (only) on the same station, and possibly have password values, you need to pass the <code>ValueDocEncoder</code> a <a href="module://docDeveloper/doc/baja-rt/javax/baja/security/PasswordEncodingContext.bajadoc"><code>PasswordEncodingContext</code></a> that instructs the encoder to use the &lsquo;keyring&rsquo; key source.</p>
<p>Encoding examples:</p>
<pre><code class="sunlight-highlight-java">
BComponent componentToEncode;
OutputStream bogFileOut;
Context cx;
BPassword filePassphrase;
ValueDocEncoder encoder;

// In this example, componentToEncode has no reversible passwords. Because we don't pass a special
// PasswordEncodingContext to the constructor and we don't provide a passphrase, 'none' key source is used.
encoder = new ValueDocEncoder(bogFileOut, cx);
encoder.setZipped(true);
encoder.encode(componentToEncode);

// In this example, we encrypt passwords using a key from the station's keyring. updateForKeyring isn't appropriate
// for code running anywhere except in a station VM, and isn't appropriate for writing files that need to be read
// by code not running on the same station.
encoder = new ValueDocEncoder(bogFileOut, PasswordEncodingContext.updateForKeyring(cx));
encoder.setZipped(true);
encoder.encode(componentToEncode);

// In this example, we encrypt passwords using a key generated from a given file passphrase.
encoder = new ValueDocEncoder(bogFileOut, cx);
encoder.setPassPhrase(Optional.of(filePassphrase));
encoder.setZipped(true);
encoder.encode(componentToEncode);
</code></pre>
<p>Decoding examples:</p>
<pre><code class="sunlight-highlight-java">
BComponent decodedComponent;
InputStream bogFileIn;
Context cx;
BPassword filePassphrase;
ValueDocDecoder decoder;

// This example will work with a bog file that has 'none' encoding, or with a bog file written using 'keyring' by the
// this VM's station.
decoder = new ValueDocDecoder(bogFileIn, cx);
decodedComponent = decoder.decodeDocument();

// This example will work with a bog file that has 'external' encoding
decoder = new ValueDocDecoder(bogFileIn, cx);
decoder.setPassPhrase(Optional.of(filePassphrase));
decodedComponent = decoder.decodeDocument();
</code></pre>
<h2 id="syntax">Syntax</h2>
<p>The bog format conforms to a very simple syntax.  The root element of a bog document must always be &ldquo;bajaObjectGraph&rdquo;. Root element attributes:</p>
<table>
  <thead>
    <tr><th align="left">Attribute</th><th align="left">Description</th></tr>
  </thead>
  <tbody>
    <tr><td align="left"><strong>version</strong></td><td align="left">Bog schema version. Value is 1.0 for Niagara AX, 4.0 for Niagara 4</td></tr>
    <tr><td align="left"><strong>reversibleEncodingKeySource</strong></td><td align="left">New to Niagara 4. Specifies where the encryption key used for password values should come from. Possible values are &lsquo;none&rsquo;(default), &lsquo;keyring&rsquo; and &lsquo;external&rsquo;.</td></tr>
    <tr><td align="left"><strong>reversibleEncodingValidator</strong></td><td align="left">Required for Niagara 4 files that use &lsquo;external&rsquo; key source.</td></tr>
    <tr><td align="left"><strong>reversibleEncodingSalt</strong></td><td align="left">Required for Niagara 4 files that use &lsquo;external&rsquo; key source.</td></tr>
    <tr><td align="left"><strong>reversibleEncodingIterationCount</strong></td><td align="left">Required for Niagara 4 files that use &lsquo;external&rsquo; key source.</td></tr>
  </tbody>
</table>
<p>Under the root there are only three element types, which map to the three slot types:</p>
<table>
  <thead>
    <tr><th align="left">Element</th><th align="left">Description</th></tr>
  </thead>
  <tbody>
    <tr><td align="left"><strong>p</strong></td><td align="left">Contains information about a property slot</td></tr>
    <tr><td align="left"><strong>a</strong></td><td align="left">Contains information about a frozen action slot</td></tr>
    <tr><td align="left"><strong>t</strong></td><td align="left">Contains information about a frozen topic slot</td></tr>
  </tbody>
</table>
<p>All other information is encoded into XML attributes:</p>
<table>
  <thead>
    <tr><th align="left">Attribute</th><th align="left">Description</th></tr>
  </thead>
  <tbody>
    <tr><td align="left"><strong>n</strong></td><td align="left">This required attribute stores the slot name.</td></tr>
    <tr><td align="left"><strong>m</strong></td><td align="left">Defines a module symbol using the format &ldquo;symbol=name&rdquo;. Once defined, the symbol is used in subsequent <code>t</code> attributes.</td></tr>
    <tr><td align="left"><strong>t</strong></td><td align="left">Specifies the type of a property using the format &ldquo;symbol:typename&rdquo;, where symbol must map to a module declaration earlier in the document.  If unspecified, then the type of the property&rsquo;s default value is used.</td></tr>
    <tr><td align="left"><strong>f</strong></td><td align="left">Specifies slot flags using the format defined by <code>Flags.encodeToString()</code></td></tr>
    <tr><td align="left"><strong>h</strong></td><td align="left">This attribute specifies the handle of BComponents</td></tr>
    <tr><td align="left"><strong>x</strong></td><td align="left">Specifies the slot facets using format defined by <code>BFacets.encodeToString()</code></td></tr>
    <tr><td align="left"><strong>v</strong></td><td align="left">Stores the string encoding of BSimples.</td></tr>
  </tbody>
</table>
<p>In practice the XML will be a series of nested <code>p</code> elements which map to the structure of the BComplex tree.  The leaves of tree will be the BSimples stored in the <code>v</code> attribute.</p>
<h2 id="example">Example</h2>
<p>A short example of a <code>kitControl:SineWave</code> linked to a <code>kitControl:Add</code> component.  The Add component has a dynamic slot called description where value is &ldquo;hello&rdquo;, operator flag is set, and facets are defined with <code>multiLine=true</code>.</p>
<pre><code class="sunlight-highlight-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;bajaObjectGraph version=&quot;4.0&quot; reversibleEncodingKeySource=&quot;none&quot;&gt;
  &lt;p m=&quot;b=baja&quot; t=&quot;b:UnrestrictedFolder&quot;&gt;
    &lt;p n=&quot;SineWave&quot; h=&quot;1&quot; m=&quot;kitControl=kitControl&quot; t=&quot;kitControl:SineWave&quot;&gt;
      &lt;p n=&quot;amplitude&quot; v=&quot;35&quot;/&gt;
    &lt;/p&gt;
  &lt;p n=&quot;Add&quot; h=&quot;3&quot; t=&quot;kitControl:Add&quot;&gt;
  &lt;/p&gt;
  &lt;p n=&quot;Link&quot; t=&quot;b:Link&quot;&gt;
    &lt;p n=&quot;sourceOrd&quot; v=&quot;h:1&quot;/&gt;
    &lt;p n=&quot;sourceSlotName&quot; v=&quot;out&quot;/&gt;
    &lt;p n=&quot;targetSlotName&quot; v=&quot;inA&quot;/&gt;
  &lt;/p&gt;
  &lt;p n=&quot;description&quot; f=&quot;o&quot; x=&quot;multiLine=b:true&quot; t=&quot;b:String&quot; v=&quot;hello&quot;/&gt;
  &lt;/p&gt;
&lt;/bajaObjectGraph&gt;
</code></pre>

<script type='text/javascript'>window.niagara.docDevUtil.highlightCode();</script>

<!-- Auto-generated Footer NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/xml.html" class="navbar">Prev</a> |  <a href="/doc/distribution.html" class="navbar">Next</a></p>
<!-- Auto-generated copyright note --><p class='copyright'></p>
</body>
</html>
