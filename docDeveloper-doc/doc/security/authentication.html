<!-- Htmldoc has been run -->
<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<link rel='stylesheet' href='module://docDeveloper/rc/sunlight.default.css'>
<!-- Auto-generated style sheet link --><link rel='StyleSheet' href='module://bajaui/doc/style.css' type='text/css' />
<!-- Auto-generated js link for Activity Monitoring --><script type='text/javascript' src='module://web/rc/util/activityMonitor.js'></script>
<script type='text/javascript'>window.addEventListener('load', activityMonitor.start);</script>
</head>
<body>
<!-- Auto-generated Header NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/security/requestingPermissions.html" class="navbar">Prev</a> |  <a href="/doc/security/roles.html" class="navbar">Next</a></p>

<script type='text/javascript' src='module://docDeveloper/rc/sunlight-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.java-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.javascript-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.xml-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.css-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/niagara-sunlight-support.js'></script>

<h1 id="authentication">Authentication</h1>
<h1 id="overview">Overview</h1>
<p>In Niagara 4, the Authentication Service manages how users can log in to the station. It supports using multiple Authentication Schemes at once, so that different users can log in using different methods appropriate to the type or sensitivity of the account. Developers can create additional Authentication Schemes if desired.</p>
<h1 id="authentication-service-model">Authentication Service Model<a name="authnServiceModel"></a></h1>
<h2 id="overview">Overview</h2>
<p>In Niagara 4, all authentication (that is, how users prove who they are to the station) is managed by the Authentication Service. In a Niagara 4 station, all authentication requests are routed through the Authentication Service. The types of authentication a station supports (both for fox and web) is determined solely by the Authentication Service. This results in a more robust authentication framework. Functionality that can be centralized is handled by the service itself, avoiding duplication of code. Functionality that cannot be centralized is handled by specialized handlers, which can be reused.</p>
<p>In this section, we describe how the Authentication Service works, and what steps are required to create new authentication schemes.</p>
<h2 id="authentication-schemes">Authentication Schemes</h2>
<p>The most important element of the Niagara 4 Authentication Service is the Authentication Scheme. An Authentication Scheme determines how the client authenticates to the server. For example, with the <code>HTTPBasicAuthenticationScheme</code>, a username and password are sent over in plaintext; with the <code>DigestAuthenticationScheme</code>, multiple messages are passed back and forth to prove the client knows the password, without ever actually sending the password.</p>
<p>A station can support multiple authentication schemes. Each user account is tied to a specific scheme. This allows more sensitive accounts to use a more secure scheme (e.g. digest or two-factor), while still allowing other accounts to use other schemes such as LDAP. This is done via the <code>authenticationSchemeName</code> property on the <code>BUser</code>, which allows you to choose any Authentication Scheme configured in the Authentication Service and assign it to that user.</p>
<p>New schemes are added to the Authentication Service and configured as needed (e.g. the LDAP scheme will require certain parameters like the URL of the LDAP server to which you wish to connect). Only schemes added to the Authentication Service are supported by that station.</p>
<h2 id="using-the-authentication-service">Using the Authentication Service</h2>
<p>In this section, we&rsquo;ll discuss how to set up a station to use the Authentication Service.</p>
<h3 id="add-the-authentication-service">Add the Authentication Service</h3>
<p>Each station needs an Authentication Service. New stations are created with an AuthenticationService already in the &ldquo;Services&rdquo; container. If you have accidentally removed the AuthenticationService, you can manually add one from the &ldquo;baja&rdquo; palette into the &ldquo;Services&rdquo; container.</p>
<h3 id="add-the-desired-authentication-schemes">Add the Desired Authentication Schemes</h3>
<p>A station may support multiple Authentication Schemes. Which ones you want depends entirely on what you need your station to do.</p>
<p>Authentication Schemes should be added to the AuthenticationService&rsquo;s <code>AuthenticationSchemes</code> folder. Only schemes in that folder are supported by the station.</p>
<p>Each station is created with the DigestAuthenticationScheme and AXDigestAuthenticationScheme in the <code>AuthenticationSchemes</code> folder. This way, any Niagara 4 station can do digest authentication with both N4 and AX clients.</p>
<p>Additional Schemes can be found in the baja and ldap palettes. Schemes may be added or removed from the <code>AuthenticationSchemes</code> folder, but be aware that removing a scheme may leave your users with an invalid reference to a non-existent scheme, and unable to log in.</p>
<h3 id="assign-authentication-schemes-to-users">Assign Authentication Schemes to Users</h3>
<p>In Niagara 4, each user is assigned its own AuthenticationScheme. This allows different users to use different schemes appropriate to the user type. For example, the DigestScheme is appropriate for human users, whereas the HTTPBasicScheme is more appropriate for devices that can&rsquo;t do digest.</p>
<p>A user&rsquo;s AuthenticationScheme can be changed via the user&rsquo;s <code>authenticationSchemeName</code> property in the user&rsquo;s property sheet. Simply select the desired scheme from the drop down list.</p>
<p>Once these setup steps are complete, the station should be ready for authentication. Note that by default, each new station comes with the Digest scheme installed, which is assigned to all users by default, so that in simple cases no additional setup is required.</p>
<h2 id="creating-an-authentication-scheme">Creating an Authentication Scheme</h2>
<p>When creating a new authentication scheme, there are a few things to take into consideration:</p>
<ul>
  <li>The station must know how to gather information from the client.</li>
  <li>The client must know how to provide the server with information.</li>
  <li>The station must know how to process the information it gathers.</li>
  <li>Multiple protocols (e.g. fox or web) may need to be supported.</li>
</ul>
<p>For each new authentication scheme created, a number of handlers may also need to be created to ensure that communication is possible between the client and the server. In this section, we will go over all the different objects that must be created when implementing a new authentication scheme.</p>
<ul>
  <li>Step 1: Create a <a href="module://docDeveloper/doc/baja-rt/javax/baja/authn/BAuthenticationScheme.bajadoc"><code>BAuthenticationScheme</code></a> subclass</li>
  <li>Step 2: Create a <a href="http://docs.oracle.com/javase/8/docs/api/javax/security/auth/spi/LoginModule.html"><code>LoginModule</code></a></li>
  <li>Step 3: Create the <code>BAuthenticationScheme</code> building blocks
    <ul>
      <li><code>CallbackHandler</code>s</li>
      <li>Fox
        <ul>
          <li><a href="module://docDeveloper/doc/fox-rt/javax/baja/fox/authn/BFoxCallbackHandler.bajadoc"><code>BFoxCallbackHandler</code></a></li>
          <li><a href="module://docDeveloper/doc/fox-rt/javax/baja/fox/authn/BFoxClientAuthnHandler.bajadoc"><code>BFoxClientAuthnHandler</code></a></li>
        </ul>
      </li>
      <li>Workbench
        <ul>
          <li><a href="module://docDeveloper/doc/workbench-wb/javax/baja/workbench/authn/BWbDialogHandler.bajadoc"><code>BWbDialogHandler</code></a></li>
        </ul>
      </li>
      <li>Web
        <ul>
          <li><a href="module://docDeveloper/doc/web-rt/javax/baja/web/authn/BWebCallbackHandler.bajadoc"><code>BWebCallbackHandler</code></a></li>
          <li><a href="module://docDeveloper/doc/web-rt/javax/baja/web/authn/BILoginHTMLForm.bajadoc"><code>BILoginHTMLForm</code></a></li>
          <li><a href="module://docDeveloper/doc/web-rt/javax/baja/web/authn/BHttpHeaderCallbackHandler.bajadoc"><code>BHttpHeaderCallbackHandler</code></a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<h3 id="step-1-create-a-bauthenticationscheme-subclass">Step 1: Create a BAuthenticationScheme subclass</h3>
<p>Each new authentication scheme must be a subclass of <code>BAuthenticationScheme</code>. A <code>BAuthenticationScheme</code> is essentially a wrapper for a JAAS (Java Authentication and Authorization Service) <code>LoginModule</code>. Each subclass must implement the following methods:</p>
<ul>
  <li><code>getSchemeName()</code>. This should return a String containing a <strong>unique</strong> name for the authentication scheme (e.g. &ldquo;n4digest&rdquo; or &ldquo;n4HTTPBasic&rdquo;). This name will be used by the server to inform the client which scheme is being used.</li>
  <li><code>getLoginConfiguration()</code>. This should return a JAAS login <code>Configuration</code> that indicates which login module(s) to use, whether they are required, and what options to use. In most cases, a new <code>NiagaraLoginConfiguration</code> can be created with the appropriate <code>LoginModule</code> name, the <code>LoginModuleControlFlag.REQUIRED</code> flag, and whatever options are appropriate to the scheme (e.g. LDAP server name).</li>
</ul>
<p><code>BAuthenticationScheme</code> subclasses must also be declared as agents on <code>BAuthenticationScheme</code>.</p>
<h3 id="step-2-create-a-loginmodule">Step 2: Create a LoginModule</h3>
<p>One of the most important pieces of a new Authentication Scheme is its corresponding JAAS <a href="http://docs.oracle.com/javase/8/docs/api/javax/security/auth/spi/LoginModule.html"><code>LoginModule</code></a>. The <code>LoginModule</code> decides what information it needs from the user, delegates the task of acquiring it to the various handlers described in step 3, and then processes that information to determine whether authentication was successful or not.</p>
<p>For example, an authentication scheme for a basic authentication scheme could acquire the username and password from the user, and then compare the password to the stored hash to determine if the supplied password was correct. An LDAP scheme, on the other hand, might acquire the username and password from the user in the same way, but would then turn around and authenticate to the LDAP server rather than compare to an internally stored password.</p>
<p>A full discussion of how to create a JAAS <code>LoginModule</code> is beyond the scope of this document. For more information, see Oracle’s <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html">LoginModule Developer’s Guide</a>.</p>
<h3 id="step-3-create-the-bauthenticationscheme-building-blocks">Step 3: Create the BAuthenticationScheme building blocks</h3>
<p>In order to keep <code>BAuthenticationScheme</code>s modular and easily extensible, authentication functionality is separated into a number of building blocks. Each building block provides a different piece of completely self-contained functionality.</p>
<p>Depending on what you want your <code>BAuthenticationScheme</code> to support, some of the building blocks may not be required. For example, an Authentication Scheme meant only to be used only over fox does not need any of the web building blocks. Note that this would mean that users using this scheme would not be able to log in via the web.</p>
<p>The building blocks are described in the following sections, grouped by functionality.</p>
<h4 id="callbackhandlers">CallbackHandlers</h4>
<p>As mentioned in Step 2, the LoginModule delegates the task of acquiring user information to a JAAS <code>CallbackHandler</code>. In essence, the <code>LoginModule</code> doesn&rsquo;t care how the information it needs is acquired, so long as it is acquired. Different <code>CallbackHandler</code>s can acquire the same information in different ways.</p>
<p>This is particularly important for Niagara – it means that the same <code>LoginModule</code> can be used for both fox and web authentication, or any other protocol we might want to use. The only thing that needs to be added is a new <code>CallbackHandler</code> for each required protocol. It also means that different <code>LoginModule</code>s that happen to require the same information can get it using the same <code>CallbackHandler</code>s, and can then process it differently.</p>
<p>In Niagara 4, we have two <code>CallbackHandler</code> superclasses defined, one for fox (<code>BFoxCallbackHandler</code>) and one for web (<code>BWebCallbackHandler</code>). Each <code>BAuthenticationScheme</code> must be associated to a subclass of these in order for authentication over that protocol to be possible.</p>
<h4 id="fox">Fox</h4>
<p>For <code>BAuthenticationScheme</code>s intended to communicate over Fox, both the <code>BFoxCallbackHandler</code> and <code>BFoxClientAuthnHandler</code> must be implemented.</p>
<h5 id="bfoxcallbackhandler">BFoxCallbackHandler</h5>
<p>All <code>CallbackHandler</code>s intending to acquire information over fox for a scheme&rsquo;s <code>LoginModule</code> <strong>must</strong> be a subclass of <code>BFoxCallbackHandler</code>. Each subclass <strong>must</strong> implement JAAS&rsquo;s <code>CallbackHandler.handle(Callback[] callbacks)</code> method, which will send and receive messages over fox to acquire information from the client, and fill in the <code>callbacks</code> array with the appropriate information.</p>
<p>It <strong>may</strong> override <code>BFoxCallbackHandler.init(FoxSession session)</code>, which is called before starting the <code>LoginModule</code> login process. If it is overridden, <code>super(session)</code> <strong>must</strong> be called, as it ties the <code>BFoxCallbackHandler</code> to a specific <code>FoxSession</code>, allowing it to send messages to the client.</p>
<p><strong>To associate a BFoxCallbackHandler to a specific <code>BAuthenticationScheme</code>, it must be declared as an agent on that scheme.</strong></p>
<h5 id="bfoxclientauthnhandler">BFoxClientAuthnHandler</h5>
<p>The <code>BFoxClientAuthnHandler</code> is the client counterpart to the server&rsquo;s <code>BFoxCallbackHandler</code>. Although the client doesn&rsquo;t specifically need a <code>CallbackHandler</code> (which is only required for JAAS <code>LoginModules</code>), it does need to know what messages to expect from the server and how to respond to them. Therefore, each new <code>BAuthenticationScheme</code> must be associated with a subclass of <code>BFoxClientAuthnHandler</code>, which is &ldquo;paired&rdquo; to a <code>BFoxCallbackHandler</code>.</p>
<p>Subclasses of <code>BFoxClientAuthnHandler</code> <strong>must</strong> implement <code>handleAuthentication(FoxSession session, BICredentials credentials)</code>, which is responsible for sending and receiving messages over fox, to give the station the information it needs for authentication. The messages it receives should correspond to the messages sent by the corresponding <code>BFoxCallbackHandler</code>, and vice-versa.</p>
<p><strong>To associate a <code>BFoxClientAuthnHandler</code> to a specific <code>BAuthenticationScheme</code>, it must be declared as an agent on that scheme.</strong></p>
<h4 id="workbench">Workbench</h4>
<p>If your <code>BAuthenticationScheme</code> will be used for users logging in via Workbench, a <code>BWbDialogHandler</code> <strong>must</strong> be created.</p>
<h5 id="bwbdialoghandler">BWbDialogHandler</h5>
<p>Different <code>BAuthenticationScheme</code>s may require the user to supply different credentials. For example, digest authentication requires only a username and password. Two-factor authentication, on the other hand, requires a username and password, as well as an additional token. Workbench needs to know which dialog to present to the user in order to collect the appropriate information.</p>
<p>The <code>BWbDialogHandler</code> is responsible for building the appropriate dialogs when Workbench attempts to log in to a station.</p>
<p>Subclasses of <code>BWbDialogHandler</code> <strong>must</strong> implement <code>getPaneForStep(AuthenticationRealm realm, int step, BIObject seedInfo)</code>, which constructs and returns an appropriate <code>BCredInputPane</code> for the given authentication step. While many authentication schemes will only have a single step, some may require multiple passes to enter additional credentials; since these steps may require different credentials from the user, a different pane can be built for each step.</p>
<p>The <code>BIObject seedInfo</code> argument can be used to pre-populate the pane. For example, if the username and password have previously been stored, they can be pre-filled for the user.</p>
<h4 id="web">Web</h4>
<p>If your <code>BAuthenticationScheme</code> is meant for users who will be logging in via the web interface, a <code>BWebCallbackHandler</code> <strong>must</strong> be implemented. <em>For users logging in via the browser</em>, a <code>BILoginHTMLForm</code> <strong>must</strong> be implemented.</p>
<h5 id="bwebcallbackhandler">BWebCallbackHandler</h5>
<p>All <code>CallbackHandler</code>s intending to acquire information over HTTP for a scheme&rsquo;s <code>LoginModule</code> <strong>must</strong> be a subclass of <code>BWebCallbackHandler</code>. Each subclass <strong>must</strong> implement <code>BWebCallbackHandler.handleRequest(HttpServletRequest req, HttpServletResponse resp)</code>, which is responsible for acquiring information from the user by processing HTTP requests and sending HTTP responses.</p>
<p>Each subclass <strong>must</strong> also implement JAAS&rsquo;s <code>CallbackHandler.handle(Callback[] callbacks)</code> method, which uses the data acquired from the user in <code>handleRequest()</code> to fill in the callbacks array.</p>
<p>Note that the mechanism for acquiring information is slightly different for <code>BFoxCallbackHandler</code> and <code>BWebCallbackHandler</code>. While fox allows us to send multiple messages within a single call to <code>handle(Callback[] callbacks)</code>, the servlet request handling process does not allow us to make multiple requests and responses within a single method. Since <code>LoginModule</code>s don&rsquo;t support a partial login process, we are forced to gather all the user information before we start the login process at all. Therefore, <code>handleRequest()</code> will continue to be called until it returns a state of <code>BWebCallbackHandler.READY</code>, indicating that it has all the information it needs to process a <code>handle()</code> call, at which point the <code>LoginModule</code>&rsquo;s login process will begin.</p>
<p><strong>To associate a BWebCallbackHandler to a specific <code>BAuthenticationScheme</code>, it must be declared as an agent on that scheme.</strong></p>
<h5 id="biloginhtmlform">BILoginHTMLForm</h5>
<p>Just as we need to let a fox client know how to handle fox authentication messages, we also need to ensure that a web client knows what information to acquire from the user, how to acquire it, and how to send it back to the server. We do this by ensuring that each <code>BAuthenticationScheme</code> can create its own customizable HTML login form – each <code>BAuthenticationScheme</code> must be associated with a class implementing the <code>BILoginHTMLForm</code> interface.</p>
<p>Classes implementing the <code>BILoginHTMLForm</code> interface must implement the <code>getLoginFormHTML(Context context)</code> method. This method is responsible for creating an HTML snippet containing any input fields, buttons, or additional information the login form might require. The context argument can be used to pass in a <code>Locale</code>, or any other customizable information supported by the <code>BILoginHTMLForm</code> (<code>BDigestLoginHTMLForm</code>, for example, allows the username, password and login labels to be customized via the context argument).</p>
<p><strong>To associate a <code>BILoginHTMLForm</code> to a specific <code>BAuthenticationScheme</code>, it must be declared as an agent on that scheme.</strong></p>
<h5 id="bhttpheadercallbackhandler">BHttpHeaderCallbackHandler</h5>
<p>If you intend to support the <a href="module://docDeveloper/doc/security/headerAuthentication.html">HTTP Header Authentication Mechanism</a> in your <code>BAuthenticationScheme</code>, you must create a callback handler that is a subclass of <code>BHttpHeaderCallbackHandler</code>.</p>
<p>This <code>CallbackHandler</code> behaves very similar to the <code>BWebCallbackHandler</code>, the only differences being that a <code>BHttpHeaderCallbackHandler</code> will only be used when the client starts the authentication process with a <code>HELLO</code> message, and the <code>CallbackHandler</code> should exchange authentication information using only the headers described in <a href="module://docDeveloper/doc/security/headerAuthentication.html">HTTP Header Authentication Mechanism</a>.</p>
<p><strong>To associate a BHttpHeaderCallbackHandler to a specific <code>BAuthenticationScheme</code>, it must be declared as an agent on that scheme.</strong></p>
<h2 id="process-overview">Process Overview</h2>
<p>This figure outlines the login process over fox, and how the various pieces (BAuthenticationScheme, LoginModule, BFoxCallbackHandler and BFoxClientAuthnHandler) fit together.</p>
<p><img src="authentication_fox.png" alt="Fox Authentication Process" title="Fox Authentication Process" /></p>
<h1 id="niagara-ax-to-niagara-4-api-changes">Niagara AX to Niagara 4 API Changes</h1>
<h2 id="overview">Overview</h2>
<p>In Niagara AX, authentication is handled by a number of different services and agents. The Fox Service, Web Service and User Service all determine in part what type of authentication the station supports. Not all possible configurations are valid, and this can lead to confusion and reduced security. What&rsquo;s more, because authentication is handled in so many different places, the authentication system tends to be fairly fragile.</p>
<p>In Niagara 4, the authentication model has been changed so that all authentication functionality goes through a single service, the Authentication Service. This helps centralize common functionality like auditing or approving or rejecting authentication, and allows us to easily create and integrate new authentication schemes.</p>
<p>For more information about the Niagara 4 Authentication Service, view the <a href="#authnServiceModel">Authentication Service Model</a> section. As a result of these changes, some modifications were made to the API. These are described below.</p>
<h2 id="who-is-impacted">Who is Impacted</h2>
<p>Any custom authentication implementation using <code>BAuthAgents</code> or subclasses of <code>BUserService</code> will be affected.</p>
<h2 id="what-changed">What Changed</h2>
<p>A number of things have changed with the new Authentication Service implementation:</p>
<ul>
  <li><code>BAuthAgents</code> are no longer used for authentication. Any implementation of a <code>BAuthAgent</code> will need to be refactored into the appropriate <code>BFoxCallbackHandler</code>, <code>BWebCallbackHandler</code>, <code>BFoxClientAuthHandler</code> and <code>BILoginHTMLForm</code> components.</li>
  <li>All <code>BAuthAgents</code> have been removed. Any code that uses or implements <code>BAuthAgent</code> will not compile.</li>
  <li>The methods <code>BUserService.getAuthAgent()</code> and <code>BUserService.authenticateBasic()</code> have been removed.</li>
  <li>The <code>authenticationPolicy</code> and <code>legacyAuthentication</code> properties has been removed from <code>BFoxService</code>.</li>
  <li>The <code>authenticationScheme</code> property has been removed from <code>BWebService</code>.</li>
  <li><code>javax.baja.web.BAuthenticationType</code> has been removed.</li>
  <li>All stations must have an Authentication Service for authentication to be possible.</li>
  <li>There is no longer any need to subclass <code>BUserService</code> if an alternate authentication scheme is desired.</li>
</ul>
<h2 id="resolution">Resolution</h2>
<p>Any custom <code>BAuthAgent</code> should be replaced by the various components described in the <a href="#authnServiceModel">Authentication Service Model</a> section.</p>
<p>Subclasses of <code>BUserService</code> are no longer required to implement alternate authentication schemes. Authentication specific elements of the <code>BUserService</code> subclasses should be moved to the appropriate <code>BAuthenticationScheme</code> component (e.g. the scheme&rsquo;s <code>LoginModule</code>).</p>

<script type='text/javascript'>window.niagara.docDevUtil.highlightCode();</script>

<!-- Auto-generated Footer NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/security/requestingPermissions.html" class="navbar">Prev</a> |  <a href="/doc/security/roles.html" class="navbar">Next</a></p>
<!-- Auto-generated copyright note --><p class='copyright'></p>
</body>
</html>
