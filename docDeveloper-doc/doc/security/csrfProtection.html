<!-- Htmldoc has been run -->
<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<link rel='stylesheet' href='module://docDeveloper/rc/sunlight.default.css'>
<!-- Auto-generated style sheet link --><link rel='StyleSheet' href='module://bajaui/doc/style.css' type='text/css' />
<!-- Auto-generated js link for Activity Monitoring --><script type='text/javascript' src='module://web/rc/util/activityMonitor.js'></script>
<script type='text/javascript'>window.addEventListener('load', activityMonitor.start);</script>
</head>
<body>
<!-- Auto-generated Header NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/security/scramshaexample.html" class="navbar">Prev</a> |  <a href="/doc/security/codeSigning.html" class="navbar">Next</a></p>

<script type='text/javascript' src='module://docDeveloper/rc/sunlight-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.java-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.javascript-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.xml-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.css-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/niagara-sunlight-support.js'></script>

<h1 id="protecting-http-servlets-against-csrf">Protecting Http Servlets against CSRF</h1>
<p>Cross-Site Request Forgery (CSRF) is a type of attack that occurs when a malicious Web site, email, blog, instant message, or program causes a user&rsquo;s Web browser to perform an unwanted action on a trusted site for which the user is currently authenticated. Any web request that can result in a state change is considered vulnerable to CSRF attacks. For example, HTTP POST requests typically result in a state change and are susceptible to CSRF attacks.</p>
<p>Niagara currently has a Servlet Filter that can be configured to route your servlets via the filter and verify if they are CSRF protected. This document will help you ensure your servlets are correctly configured and accessed to ensure CSRF protection.</p>
<h2 id="configuration">Configuration</h2>
<p>CsrfProtectedFilter is the Filter class that is defined in the web.XML file of the web module. In your web.xml file, configure the servlet(s) specifying the Http methods to be protected. See example below that protects the POST method of /rpc servlet requests.</p>
<p><em>Note that additional Http methods to be protected can be provided as comma (&ldquo;,&rdquo;) separated. Example, POST, PUT, DELETE</em></p>
<pre><code class="sunlight-highlight-xml">&lt;!-- CSRF Protect NiagaraRpcServlet servlet --&gt;
&lt;filter&gt;
  &lt;filter-name&gt;csrfProtectedNiagaraRpcFilter&lt;/filter-name&gt;
  &lt;filter-class&gt;javax.baja.web.filters.CsrfProtectedFilter&lt;/filter-class&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;httpMethod&lt;/param-name&gt;
    &lt;param-value&gt;POST&lt;/param-value&gt;
  &lt;/init-param&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
  &lt;filter-name&gt;csrfProtectedNiagaraRpcFilter&lt;/filter-name&gt;
  &lt;url-pattern&gt;/rpc&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>
<p>The above configuration now protects /rpc POST requests against CSRF. Just by making this change to your web.xml, you will ensure that all /rpc requests are rejected with a unauthorized exception if a valid token (explained below) is not passed with the request.</p>
<h2 id="passing-the-csrf-token">Passing the CSRF token</h2>
<p>A CSRF token is generated per session and must be passed with every request that is intended to be protected from CSRF attacks.</p>
<p>There are 3 ways a CSRF token can be passed from a client,</p>
<ul>
  <li>As a url query string (typically for GET requests).</li>
  <li>As a form post parameter (typically for POST requests).</li>
  <li>Explicitly passed via a Http header (typically for AJAX POST requests)</li>
</ul>
<h3 id="as-a-query-string">As a query string</h3>
<pre><code class="sunlight-highlight-xml">Example:
http://localhost/SampleServletGet?csrfToken=aToken
</code></pre>
<p><em>NOTE: How to get the token is discussed in a separate section below</em></p>
<h3 id="as-a-form-post-parameter">As a form post parameter</h3>
<p>The CSRF token is already embedded in all the profiles and will be automatically available for every form POST.</p>
<h3 id="explictly-as-a-http-header">Explictly as a Http header</h3>
<p><em>&ldquo;x-niagara-csrfToken&rdquo; is the Http header key that will carry the CSRF token.</em></p>
<pre><code class="sunlight-highlight-xml">//Sample jquery ajax request with csrf header
$.ajax(url, {
  dataType: &quot;text&quot;,
  method: &quot;PUT&quot;,
  data: someData,
  headers: {
    &quot;x-niagara-csrfToken&quot;: &quot;aToken&quot;
  }
})
</code></pre>
<p>See <a href="module://docDeveloper/doc/jsdoc/js-ux/csrfUtil.html">Examples and API</a>.</p>
<p><em>NOTE: For an AJAX POST/PUT kind of requests, it is strongly recommended to pass the csrftoken as a header and not part of the form post body which may lead to unexpected behavior. Passing via header also ensures the request stream is not consumed.</em></p>
<h2 id="how-to-get-the-csrf-token-in-different-niagara-profilesviews">How to get the CSRF token in different Niagara profiles/views</h2>
<p>Bajaux and Hx views have APIs to access the CSRF token.</p>
<pre><code class="sunlight-highlight-xml">//HxViews can get a token using this API
String csrfToken = SessionManager.getCurrentNiagaraSuperSession().getCsrfToken();
</code></pre>
<pre><code class="sunlight-highlight-xml">//HxViews can also get a token using the global &quot;hx&quot; Javascript API
var csrfToken = hx.getCsrfToken();
</code></pre>
<pre><code class="sunlight-highlight-xml">//Bajaux editors/widgets access a token via this API
define([&quot;nmodule/js/rc/csrf/csrfUtil&quot;], function(csrfUtil){
  'use strict';

  var csrfToken = csrfUtil.getCsrfToken();
});
</code></pre>
<h2 id="csrf-utility-java">CSRF Utility (JAVA)</h2>
<p>There is a public utility class in the web module CsrfUtil.java that provides overloaded functions to verify an incoming CSRF token.</p>
<p><em>This utility will come in handy and may be used only for code that cannot use the CsrfProtectedFilter.</em></p>
<pre><code class="sunlight-highlight-xml">//Example usage
if(CsrfUtil.verifyCsrfToken(request /*HttpServletRequest*/)){//Do something}
</code></pre>
<h1 id="velocity-and-mobile-views">Velocity and Mobile views</h1>
<p>The CSRF token is also available in velocity and mobile profiles.</p>
<pre><code class="sunlight-highlight-xml">&lt;!-- Access to CSRF token in a velocity template (.vm file)--&gt;
$csrfToken //This parameter can be used anywhere in a template to get the CSRF token.
</code></pre>
<p>Mobile profile is internally generated via Velocity and the same parameter &ldquo;$csrfToken&rdquo; is available as a form field embedded in the profile.</p>
<p>Simply calling $(&lsquo;#csrfToken&rsquo;) inside a mobile view will return the CSRF token.</p>

<script type='text/javascript'>window.niagara.docDevUtil.highlightCode();</script>

<!-- Auto-generated Footer NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/security/scramshaexample.html" class="navbar">Prev</a> |  <a href="/doc/security/codeSigning.html" class="navbar">Next</a></p>
<!-- Auto-generated copyright note --><p class='copyright'></p>
</body>
</html>
