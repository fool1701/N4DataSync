<!-- Htmldoc has been run -->
<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<link rel='stylesheet' href='module://docDeveloper/rc/sunlight.default.css'>
<!-- Auto-generated style sheet link --><link rel='StyleSheet' href='module://bajaui/doc/style.css' type='text/css' />
<!-- Auto-generated js link for Activity Monitoring --><script type='text/javascript' src='module://web/rc/util/activityMonitor.js'></script>
<script type='text/javascript'>window.addEventListener('load', activityMonitor.start);</script>
</head>
<body>
<!-- Auto-generated Header NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/history.html" class="navbar">Prev</a> |  <a href="/doc/schedule.html" class="navbar">Next</a></p>

<script type='text/javascript' src='module://docDeveloper/rc/sunlight-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.java-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.javascript-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.xml-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/sunlight.css-min.js'></script>
<script type='text/javascript' src='module://docDeveloper/rc/niagara-sunlight-support.js'></script>

<h1 id="alarm">Alarm</h1>
<h1 id="introduction">Introduction</h1>
<p>The Alarm module provides core functionality for lifecycle management of alarms within the Niagara Framework.  Alarms are used to indicate that some value is not within an appropriate or expected range.  Alarms may be routed from the system to a variety of external sources, be it email, a printer or a console application.</p>
<h1 id="object-model">Object Model</h1>
<p>All alarms in the Niagara Framework are generated by objects implementing the <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BIAlarmSource.bajadoc">BIAlarmSource</a> interface.  Those alarms (<a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmRecord.bajadoc">BAlarmRecord</a>) are then routed to the <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmService.bajadoc">BAlarmService</a>. The service for storing and routing of alarms. Alarms are then routed to one or more recipients (<a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmRecipient.bajadoc">BAlarmRecipient</a>) via their <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmClass.bajadoc">BAlarmClass</a>. Starting in Niagara 4.11, a <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BArchiveAlarmProvider.bajadoc">BArchiveAlarmProvider</a> may be optionally added to the <code>BAlarmService</code> on supervisor installations to provide a mechanism to archive cleared alarms.</p>
<h2 id="alarm-sources">Alarm Sources</h2>
<p>While <code>BIAlarmSource</code> is an interface, most alarm sources are instances of <code>javax.baja.control.alarm.BAlarmSourceExt</code>, the alarm point extension.  The alarm extension determines when it&rsquo;s parent point is in an alarmable condition, and uses the <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/AlarmSupport.bajadoc">AlarmSupport</a> class to take care of routing and issuing alarms to the alarm service. The alarm source updates the alarm when the parent point goes back to its normal condition as well as notifies the point that an acknowledgement has been received.</p>
<p>Objects implementing <code>BIAlarmSource</code> that have a status (<a href="module://docDeveloper/doc/baja-rt/javax/baja/status/BStatus.bajadoc">BStatus</a>) should use the following rules when setting the status bits.</p>
<ul>
  <li>Generate Offnormal alarm: set the <code>BStatus.ALARM</code> and <code>BStatus.UNACKED_ALARM</code> bits.</li>
  <li>Generate Fault alarm: set the <code>BStatus.ALARM</code>, <code>BStatus.UNACKED_ALARM</code> and <code>BStatus.FAULT</code> bits.</li>
  <li>AckAlarm methods is called: if the alarm is the last one generated clear the BStatus.<code>UNACKED_ALARM</code> bit.</li>
  <li>Generate Normal alarm: clear the <code>BStatus.ALARM</code> and <code>BStatus.FAULT</code> bits.</li>
</ul>
<p>Note that <code>BStatus.UNACKED_ALARM</code> should only be set if the <code>BAlarmClass.ackRequired</code> bit is set for that transition in the AlarmSource&rsquo;s AlarmClass. This can easily be obtained if using the <code>AlarmSupport</code> class by calling <code>BAlarmSupport.ackRequired(BSourceState state)</code>.</p>
<h2 id="alarm-service">Alarm Service</h2>
<p>The <code>BAlarmService</code> coordinates routing of alarms within the framework.  It routes alarms from their source to the appropriate recipients, and alarm acknowledgements from the recipients back to the source.  The alarm service routes individual alarms via their alarm class. All alarm classes available to the system are maintained as slots on <code>BAlarmService</code>. The <code>BAlarmService</code> also maintains the Alarm Database. It is accessed though the <code>getAlarmDb()</code> method.</p>
<h2 id="alarm-class">Alarm Class</h2>
<p>The alarm classes, as stated above, are maintained as slots on the alarm service and serve to route alarms with similar sets of properties along common routes - they serve as channels for like data.  <code>BAlarmClass</code> manages the persistence of the alarms as needed via the alarm database. The AlarmClass manages the priority of an alarm and also which alarm require acknowledgement. Each alarm class can be linked to one or more alarm recipients.</p>
<h2 id="alarm-recipients">Alarm Recipients</h2>
<p>Alarm recipients are linked to an alarm class (from the <code>alarm</code> topic on the alarm class to the <code>routeAlarm</code> action on <code>BAlarmRecipient</code>.)  Recipients may be configured to receive alarms only at certain times of day, certain days of the week, and receiving alarms of only certain transitions (e.g. toOffnormal, toFault, toNormal, toAlert).</p>
<p>Three subclasses of <code>BAlarmRecipient</code> are worth noting: <code>BConsoleRecipient</code>, <code>BStationRecipient</code> and <code>BEmailRecipient</code>.</p>
<h3 id="bconsolerecipient">BConsoleRecipient</h3>
<p>This recipient manages the transfer of alarms between the alarm history and the alarm console, i.e. it gets open alarms from the alarm history for the console and updates the history when they are acknowledged.</p>
<h3 id="bstationrecipient">BStationRecipient</h3>
<p>This recipient manages the transfer of alarms between the alarm service and a remote Niagara station.</p>
<h3 id="bemailrecipient">BEmailRecipient</h3>
<p>The email recipient is part of the <a href="module://docDeveloper/doc/email-rt/module-index.bajadoc">email</a> package. It allows alarms to be sent to users via email.</p>
<h2 id="alarm-archive">Alarm Archive</h2>
<p>The alarm archive provides functionality to store only the cleared alarms (acknowledged and normal) to a secondary database for historical storage, which allows the main alarm database to store only the open alarms (that are displayed in the Alarm Consoles). The <code>BArchiveAlarmProvider</code> can be configured to store the cleared alarms in a remote relational database and runs periodically to export the cleared alarms.</p>
<p>This requires the <em>tridium:alarmArchive</em> feature in the license to work.</p>
<h1 id="lifecycle">Lifecycle</h1>
<p>Each alarm is a single BAlarmRecord that changes throughout its lifecycle. An alarm has four general states that it may be in:</p>
<ol>
  <li>New Alarm</li>
  <li>Acknowledged Alarm</li>
  <li>Normal Alarm</li>
  <li>Acknowledged Normal Alarm</li>
</ol>
<p>All alarms start as New Alarms and end as Acknowledged Normal Alarms. They may be acknowledged then go back to normal or go back to normal then be acknowledged. Cleared alarms (transitioned to normal or acknowledged) can be archived if an Alarm Archive is configured.</p>
<p>An Alert is an alarm that does not have a normal state and thus its lifecycle consists of New Alarm and Acknowledged Alarm.</p>
<h2 id="alarm-routing-overview">Alarm Routing Overview</h2>
<p><em>New Alarms</em></p>
<ol>
  <li><code>BIAlarmSource</code> generates an offnormal alarm (or fault alarm).</li>
  <li>It is sent to the <code>BAlarmService</code>.</li>
  <li><code>BAlarmService</code> routes it to its <code>BAlarmClass</code>.</li>
  <li>The <code>BAlarmClass</code> sets the alarm&rsquo;s priority, ackRequired bit, and optional data.</li>
  <li>It is then routed to any number of <code>BAlarmRecipient</code>s.</li>
</ol>
<p>The normal alarm is sent along this same path.</p>
<p><em>Alarm Acks</em></p>
<ol>
  <li>When a <code>BAlarmRecipient</code> acknowledges an alarm, the acknowledgement is sent to the <code>BAlarmService</code>.</li>
  <li>The <code>BAlarmService</code> routes back to the <code>BIAlarmSource</code> (if an ack is required).</li>
  <li>The Alarm Acknowledgement is then routed to AlarmRecipients along the same path as a New Alarm.</li>
</ol>
<p><em>Archive Alarms</em></p>
<ol>
  <li>An alarm becomes eligible for archival once it is cleared (transitioned to normal or acknowledged) from the <code>BConsoleRecipient</code> alarm console.</li>
  <li>The <code>BArchiveAlarmProvider</code> executes the action to archive the alarm records in the configured relational data storage.</li>
  <li>The archived alarms are viewable only via views on the Alarm Archive or via queries using <em>alarm:archive</em> extent.</li>
</ol>
<h1 id="usage">Usage</h1>
<h2 id="setup">Setup</h2>
<p>The most basic piece needed is a control point. Then add an alarm extension from the alarm module palette.  There are several types of extensions depending upon the type of point selected. The AlarmExtension are disabled by default. You must enabled toOffnormal or toFault alarms and configure and enable the alarm algorithms.</p>
<p>An Alarm Service is also required.  Depending on your needs, it may require some of the following slots:</p>
<ul>
  <li>Any desired <code>BAlarmClass</code>es should be added.</li>
  <li>A <code>BConsoleRecipient</code> should be added if an alarm console is required.</li>
</ul>
<p>Link any of the slots as needed.  The alarm recipients must be linked to an alarm class in order to receive alarms from that alarm class.</p>
<p>To generate an alarm, go to a point with an alarm extension and put it an alarm condition.</p>
<h2 id="console-recipient-alarm-console">Console Recipient / Alarm Console</h2>
<p>To view all of the outstanding alarms in the system, double click on the console recipient on the alarm service. The alarm console manages alarms on a per point basis. Each row in the alarm console is the most recent alarm from a point. To view all the current alarms from that point, double click the row.</p>
<p>To acknowledge an alarm, select the desired alarm and hit the ack button.  An alarm is cleared from the alarm console when the alarm is acknowledged AND the point is in its normal state.</p>
<p>To view more information about an unacknowledged alarm, right click and select View Details.</p>
<h2 id="station-recipient">Station Recipient</h2>
<p>A <code>BStationRecipient</code> allows sending alarms to remote Niagara stations. A remote station is selected from the stations you have configured in your Niagara Network. This recipient require that the remote station be properly configured in the Niagara Network.</p>
<h2 id="printer-recipient">Printer Recipient</h2>
<p>A <code>BPrinterRecipient</code> allows printing of alarms on an ink-jet or laser printer. This recipient is only available on Win32 Platforms. It supports both local and remote printers.</p>
<h2 id="line-printer-recipient">Line Printer Recipient</h2>
<p>A <code>BLinePrinterRecipient</code> allows printing of alarms on a Line Printer. This recipient is only available on Win32 Platforms. It supports both local and remote printers.</p>
<h2 id="archive-alarm">Archive Alarm</h2>
<p>An object implementing the <code>BArchiveAlarmProvider</code> executes the action to archive the alarm records into the configured relational data storage. <em>Execute</em> action is configurable via the <code>BArchiveAlarmProvider</code>&rsquo;s Property Sheet or can be triggered manually. It also provides a <em>Retry</em> action to export the alarms failed in the previous execution. <code>BOrionArchiveAlarmProvider</code> is the Orion implementation available in the Niagara Framework.</p>
<h1 id="niagara-ax-to-niagara-4-api-changes">Niagara AX to Niagara 4 API Changes</h1>
<h2 id="overview">Overview</h2>
<p>The Alarm API has been re-factored to better support pluggable persistent storage. This will allow for better scaling of the Niagara Alarm Service since the JACE and the Supervisor will be able to have different backing databases. The new API is connection oriented in order to support the use to RDBMS and ODBMS back-ends.</p>
<p><a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmDatabase.bajadoc">BAlarmDatabase</a> now extends <a href="'module://docDeveloper/doc/baja-rt/javax/baja/space/BSpace.bajadoc">BSpace</a>.  This is now consistent with how other storage mechanisms are <code>BSpace</code>s with their Service defining the configuration of the space.  As part of this change, database configuration properties on <code>BAlarmService</code> were refactored.</p>
<h2 id="balarmservice-balarmdatabase">BAlarmService &amp; BAlarmDatabase</h2>
<h3 id="javaxbajaalarmbalarmservicecapacity-javaxbajaalarmbalarmdbconfig">javax.baja.alarm.BAlarmService.capacity &amp; javax.baja.alarm.BAlarmDbConfig</h3>
<p>A <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/BAlarmDbConfig.bajadoc">BAlarmDbConfig</a> property named alarmDbConfig was added to <code>BAlarmService</code>.  This property will allow a greater flexibility in defining alarm storage configurations in the future. For the standard file-based Alarm Service, the capacity property was moved to the <code>BFileAlarmDbConfig</code> subclass of <code>BAlarmDbConfig</code>.</p>
<h3 id="javaxbajaalarmbalarmdatabase">javax.baja.alarm.BAlarmDatabase</h3>
<p><code>BAlarmDatabase</code> now extends <code>BSpace</code> and implements <a href="module://docDeveloper/doc/baja-rt/javax/baja/security/BIProtected.bajadoc">BIProtected</a>.  This allows the AlarmDatabase to appear in the Nav Tree as a peer to the History and System Databases and be categorized via the CategoryBrowser.  Since <code>BAlarmDbConfig</code> now defines the configuration of the alarm database, the following method was added to <code>BAlarmDatabase</code> to handle changes to the configuration.</p>
<p><em>BAlarmDatabase</em></p>
<pre><code class="sunlight-highlight-java">/**
 * Update the database with the new configuration.
 *
 * @param config new BAlarmDbConfig
 * @param p Property to update
 * @since Niagara 4.0
 */
public abstract void updateConfig(BAlarmDbConfig config, Property p)
  throws AlarmException;
</code></pre>
<p>The <code>BAlarmDatabase</code> gets a callback to <code>updateConfig()</code> for each property change on the <code>BAlarmDbConfig</code> object.</p>
<h3 id="javaxbajaalarmbalarmdbview-javaxbajaalarmbalarmdbmaintenanceview">javax.baja.alarm.BAlarmDbView &amp; javax.baja.alarm.BAlarmDbMaintenanceView</h3>
<p><code>BAlarmDbView</code> &amp; <code>BAlarmDbMaintenanceView</code> have been moved to be views on <code>BAlarmDatabase</code> instead of <code>BAlarmService</code>.</p>
<h3 id="javaxbajaalarmbalarmrecord">javax.baja.alarm.BAlarmRecord</h3>
<p><code>getSchema()</code> and <code>getRecordSize()</code> methods were added to <code>BAlarmRecord</code>.  These are currently placeholders for future use.</p>
<p>The default behaviour of the previously existing <code>BAlarmRecord</code> constructors was changed to not create a new <a href="module://docDeveloper/doc/baja-rt/javax/baja/util/BUuid.bajadoc">BUuid</a>. New constructors were created accepting a <code>BUuid</code> as an argument.</p>
<h2 id="connection-oriented-api">Connection Oriented API</h2>
<h3 id="javaxbajaalarmbialarmspace">javax.baja.alarm.BIAlarmSpace</h3>
<p>The BIAlarmSpace interface as added to provide access to the Alarm Space via a connection oriented API.  It provides the following method:</p>
<p><code>AlarmSpaceConnection getConnection(Context)</code></p>
<h3 id="javaxbajaalarmbalarmservice">javax.baja.alarm.BAlarmService</h3>
<p>The following methods have been moved to <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/AlarmSpaceConnection.bajadoc">javax.baja.alarm.AlarmSpaceConnection</a></p>
<pre><code>public void append(BAlarmRecord record)
public void update(BAlarmRecord record)
public int getRecordCount();
public BAlarmRecord getRecord(BUuid uuid)
public Cursor&lt;BAlarmSource&gt; getOpenAlarmSources()
public Cursor&lt;BAlarmRecord&gt; getOpenAlarms()
public Cursor&lt;BAlarmRecord&gt; getAckPendingAlarms()
public Cursor&lt;BAlarmRecord&gt; getAlarmsForSource(BOrdList alarmSource)
public Cursor&lt;BAlarmRecord&gt; scan()
public Cursor&lt;BAlarmRecord&gt; timeQuery(BAbsTime start, BAbsTime end)
</code></pre>
<p>The following methods have been moved to <a href="module://docDeveloper/doc/alarm-rt/javax/baja/alarm/AlarmDbConnection.bajadoc">javax.baja.alarm.AlarmDbConnection</a></p>
<pre><code>public abstract void clearAllRecords(Context cx)
public abstract void clearOldRecords(BAbsTime before, Context cx)
public abstract void clearRecord(BUuid uuid, Context cx)
</code></pre>
<p>The following method was added to provide access to the AlarmDatabase</p>
<pre><code>AlarmDbConnection getDbConnection(Context)
</code></pre>
<h3 id="javaxbajaalarmalarmspaceconnection">javax.baja.alarm.AlarmSpaceConnection</h3>
<p>The <code>AlarmSpaceConnection</code> interface is <code>AutoCloseable</code>. It provides access to the <code>IAlarmSpace</code> and allows management of connection boundaries.  Alarms are obtained, queried and updated via the <code>AlarmSpaceConnection</code>.</p>
<h3 id="javaxbajaalarmalarmdbconnection">javax.baja.alarm.AlarmDbConnection</h3>
<p><code>AlarmDbConnection</code> implements <code>AlarmSpaceConnection</code> and provides additional methods and implementations for working with <code>BAlarmDatabases</code>.</p>
<h3 id="javaxbajaalarmalarmarchive">javax.baja.alarm.AlarmArchive</h3>
<p>In Niagara 4.11, the following method was added to the <code>BAlarmService</code> to access the AlarmArchive,</p>
<pre><code>public final Optional&lt;BAlarmArchive&gt; getAlarmArchive()
</code></pre>
<p>The AlarmArchive extends from the <code>BAlarmDatabase</code>, so the alarm archive database can be accessed in the following manner:</p>
<pre><code class="sunlight-highlight-java">BAlarmService alarmService = getAlarmService();
Optional&lt;BAlarmArchive&gt; alarmArchive = alarmService.getAlarmArchive()
if (alarmArchive.isPresent())
{
    try (AlarmDbConnection conn = alarmArchive.get().getDbConnection(null))
    {
      
    }
}
</code></pre>
<p><code>BOrionAlarmArchive</code> is the Orion implementation of the Alarm Archive.</p>
<h2 id="code-samples">Code Samples</h2>
<p>The following code examples demonstrate how to convert common alarm operations from the NiagaraAX Alarm API to the Niagara 4 Alarm API.</p>
<h3 id="query-record-by-uuid">Query Record by UUID</h3>
<p><em>Niagara AX</em></p>
<pre><code class="sunlight-highlight-java">BUuid uuid = getAlarmUuid();
BAlarmRecord alarm = null;
BAlarmService alarmService = getAlarmService();
alarm = alarmService.getAlarmDb().getRecord(uuid);
</code></pre>
<p><em>Niagara 4</em></p>
<pre><code class="sunlight-highlight-java">BUuid uuid = getAlarmUuid();
BAlarmRecord alarm = null;
BAlarmService as = getAlarmService();
try (AlarmDbConnection conn = alarmService.getAlarmDb().getDbConnection(null))
{
  alarm = conn.getRecord(uuid);
}
</code></pre>
<h3 id="alarm-query">Alarm Query</h3>
<p><em>Niagara AX</em></p>
<pre><code class="sunlight-highlight-java">BAlarmDatabase alarmDb = alarmService.getAlarmDb();
Cursor cur = alarmDb.getOpenAlarms();
while (cur.next())
{
  BAlarmRecord alarm = (BAlarmRecord)cur.get();
}
</code></pre>
<p><em>Niagara 4</em></p>
<pre><code class="sunlight-highlight-java">try (AlarmDbConnection conn = alarmService.getAlarmDb().getDbConnection(null))
{
  Cursor&lt;BAlarmRecord&gt; cur = conn.getOpenAlarms();
  while (cur.next())
  {
    BAlarmRecord alarm = cur.get();
  }
}
</code></pre>
<p><em>Alarm Archive</em></p>
<p>To query the alarm archive space, use extent <code>alarm:archive</code> in the bql queries. For example,</p>
<pre><code>alarm:archive|bql: select * where source like '%/control/temp/BooleanChangeOfStateAlarmExt'
</code></pre>
<pre><code>alarm:archive|bql:select * where (sourceState = 'normal' or sourceState = 'alert') and ackState = 'acked'
</code></pre>
<p>Archived records will not be part of the openAlarms, thus below query will not result in any records from the alarm archive</p>
<pre><code>alarm:|bql:select * from openAlarms
</code></pre>
<h3 id="alarm-db-maintenance">Alarm Db Maintenance</h3>
<p><em>Niagara AX</em></p>
<pre><code class="sunlight-highlight-java">BAbsTime before = getTimeOfLastRecordToKeep();
BAlarmService service = (BAlarmService)Sys.getService(BAlarmService.TYPE);
if (service != null)
{
  service.getAlarmDb().clearOldRecords(before, getSessionContext());
}
</code></pre>
<p><em>Niagara 4</em></p>
<pre><code class="sunlight-highlight-java">BAbsTime before = getTimeOfLastRecordToKeep();
BAlarmService service = (BAlarmService)Sys.getService(BAlarmService.TYPE);
if (service != null)
{
  try (AlarmDbConnection conn = service.getAlarmDb().getDbConnection(null))
  {
    conn.clearOldRecords(before, getSessionContext());
  }
}
</code></pre>
<h3 id="create-new-balarmrecord">Create New BAlarmRecord</h3>
<p><em>Niagara AX</em></p>
<pre><code class="sunlight-highlight-java">BAlarmRecord record = new BAlarmRecord();
</code></pre>
<p><em>Niagara 4</em></p>
<pre><code class="sunlight-highlight-java">BAlarmRecord recordWithNewUuid = new BAlarmRecord(BUuid.make());
BAlarmRecord recordWithDefaultUuid = new BAlarmRecord();
</code></pre>

<script type='text/javascript'>window.niagara.docDevUtil.highlightCode();</script>

<!-- Auto-generated Footer NavBar --><p class="navbar">  <a href="/doc/index.html" class="navbar">Index</a> |  <a href="/doc/history.html" class="navbar">Prev</a> |  <a href="/doc/schedule.html" class="navbar">Next</a></p>
<!-- Auto-generated copyright note --><p class='copyright'></p>
</body>
</html>
